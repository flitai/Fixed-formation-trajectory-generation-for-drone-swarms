# Fixed-formation-trajectory-generation-for-drone-swarms

## UAVFormationControl.hpp 算法说明

## 一、整体架构

该库实现了基于**路径同步+曲率约束+自适应阵形**的固定翼无人机编队控制算法，主要包含以下核心模块：

```
┌─────────────────────────────────────────┐
│         FormationController             │  ← 主控制器
├─────────────────────────────────────────┤
│  ┌───────────┐  ┌──────────┐  ┌──────┐ │
│  │Centerline │  │  Slots   │  │ UAV  │ │
│  │  中心线    │  │  槽位     │  │ 映射 │ │
│  └───────────┘  └──────────┘  └──────┘ │
└─────────────────────────────────────────┘
```

## 二、核心数据结构

### 1. **基础几何**
- `Point2D`: 二维点，支持向量运算
- `CenterlineSample`: 中心线采样点，包含位置、切向角、曲率、弧长

### 2. **路径表示**
- `Centerline`: 弧长参数化的中心线
  - 等弧长重采样
  - 插值查询
  - 切向/法向计算

### 3. **编队配置**
- `Slot`: 槽位定义
  - `b_lat`: 横向侧距（右正左负）
  - `ds_long`: 纵向弧长错位
- `FormationTemplate`: 阵型模板生成器（纵队/线列/楔形）

### 4. **飞行器参数**
- `AircraftParams`: 包含最大滚转角、名义速度、LOS参数等

### 5. **输出接口**
- `ReferenceOutput`: 参考轨迹输出
  - 位置、航向、曲率、速度指令
  - 前馈滚转角

## 三、核心算法原理

### 1. **路径同步机制**
```cpp
// 所有成员沿同一中心线，仅弧长错位
s_i(t) = s_leader(t) - d_s,j
```
- 消除传统刚体旋转导致的"甩尾"现象
- 保证队形几何一致性

### 2. **自适应侧距收拢**
```cpp
// 内侧转弯时自动收拢
α_i = min(1, max(0, (1 - |κ|/κ_max)/(κ·b)))
n_i = α_i · b_j
```
- 防止内侧UAV超出动力学限制
- 平滑过渡避免突变

### 3. **曲率约束与速度规划**
```cpp
// 根据最大滚转角限制速度
v_max = √(g·tan(φ_max)/|κ_ref|)
```
- 确保轨迹动力学可行
- 自动减速过弯

### 4. **并行曲线生成**
```cpp
// 参考位置
P_i* = γ(s_i) + n_i·N(s_i)
// 参考曲率
κ_ref,i = κ/(1 - κ·n_i)
```
- 精确的几何变换
- 退化防护机制

## 四、主要接口功能

### 1. **初始化接口**
```cpp
// 设置中心线路径
initCenterline(points)

// 配置编队阵型
setFormation(type, num_uavs, d_s, b)

// 分配UAV到槽位
assignSlot(uav_id, slot_index)

// 设置飞行器参数
setAircraftParams(uav_id, params)
```

### 2. **实时控制接口**
```cpp
// 核心函数：计算参考轨迹
computeReference(uav_id, leader_s, dt)
  ├── 纵向同步（弧长错位）
  ├── 横向自适应（内侧收拢）
  ├── 速度规划（曲率约束）
  └── 输出参考状态

// 引导控制
computeHeadingCommand()  // LOS航向指令
computeRollCommand()      // 滚转角指令（前馈+反馈）
computeCrossTrackError()  // 横向误差
```

## 五、算法特点

### 优势
1. **统一框架**：各种阵型用同一套槽位机制表达
2. **动力学保证**：始终满足固定翼飞行约束
3. **平滑连续**：轨迹和控制指令无突变
4. **计算高效**：O(1)在线计算复杂度
5. **模块化设计**：易于集成和扩展

### 创新点
1. **路径同步**替代刚体旋转，消除甩尾
2. **自适应侧距**自动处理内侧转弯
3. **统一槽位模型**简化阵型管理
4. **曲率驱动**的速度规划

## 六、使用流程

```cpp
// 1. 创建控制器
FormationController controller;

// 2. 初始化路径
controller.initCenterline(waypoints);

// 3. 设置编队
controller.setFormation(WEDGE, 5, 20.0, 15.0);

// 4. 分配UAV
for(int i=0; i<5; i++) {
    controller.assignSlot("UAV_"+i, i);
}

// 5. 实时控制循环
while(running) {
    leader_s += v_leader * dt;
    for(each uav) {
        ref = controller.computeReference(uav_id, leader_s, dt);
        // 使用ref进行控制
    }
}
```

## 七、关键参数调优

| 参数 | 作用 | 建议范围 |
|-----|------|---------|
| `phi_max` | 最大滚转角 | 20°-35° |
| `tau_n` | 侧距平滑时间 | 1-3秒 |
| `L0` | 基础前视距离 | 5-15米 |
| `kv` | 速度相关系数 | 0.3-0.7 |
| `epsilon` | 退化防护阈值 | 0.05-0.1 |

## 八、扩展方向

1. **路径优化**：添加样条拟合、Clothoid过渡
2. **3D扩展**：增加高度维度和俯仰控制
3. **鲁棒性**：通信延迟补偿、故障处理
4. **优化分配**：动态槽位优化算法

该库提供了完整、高效、易用的编队控制解决方案，可直接集成到各类无人机仿真和控制系统中。
